<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Authelia User Admin</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
      body { padding: 20px; }
      .small-mono { font-family: monospace; font-size: 0.9em; }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Authelia â€” User Admin</h1>

      <div class="mb-3">
        <input id="search" class="form-control" placeholder="Search user..." />
      </div>

      <div id="users-area" class="mb-4"></div>

      <h3>Create user</h3>
      <form id="createForm" class="mb-4">
        <div class="row g-2">
          <div class="col-md-3"><input id="createUser" class="form-control" placeholder="username" required></div>
          <div class="col-md-3"><input id="createEmail" class="form-control" placeholder="email"></div>
          <div class="col-md-2"><input id="createDisplay" class="form-control" placeholder="displayname"></div>
          <div class="col-md-2"><input id="createGroups" class="form-control" placeholder="groups (comma)"></div>
          <div class="col-md-2"><input id="createPass" type="password" class="form-control" placeholder="password" required></div>
        </div>
        <div class="mt-2">
          <button class="btn btn-primary">Create</button>
        </div>
      </form>

      <h3>Invite (magic link)</h3>
      <form id="inviteForm" class="mb-4">
        <div class="row g-2">
          <div class="col-md-4"><input id="inviteEmail" class="form-control" placeholder="email" required></div>
          <div class="col-md-4"><input id="inviteGroups" class="form-control" placeholder="groups (comma)"></div>
          <div class="col-md-2"><input id="inviteExpires" type="number" class="form-control" placeholder="expires min" value="60"></div>
          <div class="col-md-2"><button class="btn btn-secondary">Send Invite</button></div>
        </div>
      </form>

      <hr>
      <div>
        <a class="btn btn-outline-secondary" id="reload">Reload users</a>
        <a class="btn btn-outline-secondary" id="viewLog" target="_blank" href="/admin/api/logfile">Open Log</a>
      </div>

    </div>

    <script>
      async function api(path, opts = {}) {
        const res = await fetch(path, opts);
        if (!res.ok) {
          const txt = await res.text().catch(()=>"");
          throw new Error(`HTTP ${res.status} - ${txt}`);
        }
        return res.json().catch(()=>null);
      }

      async function loadUsers() {
        try {
          const users = await api('/admin/api/users');
          renderUsers(users);
        } catch (e) {
          document.getElementById('users-area').innerHTML = `<div class="alert alert-danger">Load failed: ${e.message}</div>`;
        }
      }

      function renderUsers(users) {
        const search = document.getElementById('search').value.toLowerCase();
        let html = `<table class="table table-striped"><thead><tr><th>User</th><th>Email</th><th>Display</th><th>Groups</th><th>Actions</th></tr></thead><tbody>`;
        for (const u of Object.keys(users).sort()) {
          const data = users[u];
          const rowText = (u + (data.email||"") + (data.displayname||"")).toLowerCase();
          if (search && rowText.indexOf(search) === -1) continue;
          html += `<tr>
            <td class="small-mono">${u}</td>
            <td>${data.email || ""}</td>
            <td>${data.displayname || ""}</td>
            <td>${(data.groups || []).join(", ")}</td>
            <td>
              <button class="btn btn-sm btn-danger" onclick="del('${u}')">Delete</button>
              <button class="btn btn-sm btn-secondary" onclick="showChangePass('${u}')">Pwd</button>
              <button class="btn btn-sm btn-info" onclick="showEdit('${u}')">Edit</button>
            </td>
          </tr>`;
        }
        html += `</tbody></table>`;
        document.getElementById('users-area').innerHTML = html;
      }

      async function del(u) {
        if (!confirm('Delete ' + u + '?')) return;
        try {
          await api(`/admin/api/users/${u}`, { method: 'DELETE' });
          loadUsers();
        } catch (e) {
          alert('Delete failed: ' + e.message);
        }
      }

      function showChangePass(u) {
        const pass = prompt('New password for ' + u);
        if (!pass) return;
        fetch(`/admin/api/users/${u}/password`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ password: pass })
        }).then(r=>r.ok?loadUsers():r.text().then(t=>{throw new Error(t)})).catch(e=>alert('Error: '+e.message));
      }

      function showEdit(u) {
        const email = prompt('Email', '');
        const display = prompt('Display name', '');
        const groups = prompt('Groups (comma)', '');
        const body = {};
        if (email !== null) body.email = email;
        if (display !== null) body.displayname = display;
        if (groups !== null) body.groups = groups.split(',').map(s=>s.trim()).filter(Boolean);
        fetch(`/admin/api/users/${u}`, {
          method: 'PUT',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify(body)
        }).then(r=>r.ok?loadUsers():r.text().then(t=>{throw new Error(t)})).catch(e=>alert('Error: '+e.message));
      }

      document.getElementById('createForm').addEventListener('submit', async e => {
        e.preventDefault();
        try {
          const username = document.getElementById('createUser').value.trim();
          const email = document.getElementById('createEmail').value.trim();
          const display = document.getElementById('createDisplay').value.trim();
          const groups = document.getElementById('createGroups').value.split(',').map(s=>s.trim()).filter(Boolean);
          const password = document.getElementById('createPass').value;
          await fetch('/admin/api/users', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ username, email, displayname: display, groups, password })
          });
          document.getElementById('createForm').reset();
          loadUsers();
        } catch (err) {
          alert('Create failed: ' + err.message);
        }
      });

      document.getElementById('inviteForm').addEventListener('submit', async e => {
        e.preventDefault();
        try {
          const email = document.getElementById('inviteEmail').value.trim();
          const groups = document.getElementById('inviteGroups').value.split(',').map(s=>s.trim()).filter(Boolean);
          const expires = parseInt(document.getElementById('inviteExpires').value, 10) || 60;
          console.log('Creating invite for', email, groups, expires);
          const r = await fetch('/admin/api/invite', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ email, groups, expiresMinutes: expires })
          });
          console.log('Invite response', r);
          const json = await r.json();
          if (json.link) {
            alert('Invite created. Link:\n' + json.link);
          } else {
            alert('Invite created');
          }
          inviteForm.reset();
        } catch (err) {
          alert('Invite failed: ' + err.message);
        }
      });

      document.getElementById('reload').onclick = loadUsers;
      document.getElementById('search').oninput = loadUsers;

      loadUsers();
    </script>
  </body>
</html>
